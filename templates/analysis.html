<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen py-10">

    <div class="container max-w-6xl mx-auto p-4 md:p-8">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl">
            
            <h1 class="text-3xl font-bold text-white mb-6 text-center">ðŸ¤– AI Health Analysis</h1>

            <div class="flex flex-col md:flex-row gap-6">

                <div class="md:w-1/2">
                    <div id="ai-loading" class="text-center py-8">
                        <p class="text-lg text-purple-400">AI is analyzing your profile...</p>
                        <p class="text-sm text-gray-400 mt-2">This may take a moment.</p>
                    </div>

                    <div id="ai-result-box" class="mt-4 p-4 rounded-md bg-gray-700 border border-gray-600 text-gray-300 hidden">
                        <h2 class="text-2xl font-bold text-white mb-4" id="analysis-title">Analysis Complete</h2>
                        <div id="ai-result-text" class="text-base leading-relaxed whitespace-pre-wrap prose prose-invert max-w-none">...</div> 
                    </div>

                    <div id="ai-error-box" class="mt-4 p-4 rounded-md bg-red-900 border border-red-700 text-red-300 hidden">
                        <h2 class="text-2xl font-bold text-white mb-2">Error</h2>
                        <p id="ai-error-text">...</p>
                    </div>
                </div>

                <div class="md:w-1/2 mt-4 p-4 rounded-md bg-gray-700 border border-gray-600">
                    <h2 class="text-2xl font-bold text-white mb-4">Overall Feature Importance</h2>
                    <p class="text-sm text-gray-400 mb-4">
                        This chart shows the most important features the AI model learned from all patient data.
                    </p>
                    <img src="/static/feature_importance_plot.png" alt="Feature Importance Plot" class="rounded-lg w-full">
                </div>
            </div>
            <a href="/predictor" class="mt-8 inline-block w-full text-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                Back to Predictor
            </a>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingDiv = document.getElementById('ai-loading');
            const resultBox = document.getElementById('ai-result-box');
            const resultText = document.getElementById('ai-result-text');
            const errorBox = document.getElementById('ai-error-box');
            const errorText = document.getElementById('ai-error-text');
            const analysisTitle = document.getElementById('analysis-title');

            // 1. Parse data from URL
            const params = new URLSearchParams(window.location.search);
            const dataForServer = {};
            let prediction = "Not Found";
            let confidence = "N/A";

            params.forEach((value, key) => {
                if (key === 'prediction') {
                    prediction = value;
                } else if (key === 'confidence') {
                    confidence = value;
                }
                // Send all params to server (including prediction/confidence)
                const numValue = Number(value);
                 dataForServer[key] = isNaN(numValue) ? value : numValue;
            });

            // Set title based on prediction
            analysisTitle.textContent = `Analysis for ${prediction} Result`;
            
            // 2. Call the server endpoint instead of Google API directly
            fetchAnalysisFromServer(dataForServer);

            async function fetchAnalysisFromServer(payload) {
                try {
                    // Make a POST request to your Flask server's endpoint
                    const response = await fetch('http://localhost:5000/get_ai_analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload), // Send the data extracted from URL
                    });

                    if (!response.ok) {
                        let errorMsg = `Server error! status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (jsonError) {
                             console.error("Could not parse server error JSON:", jsonError);
                        }
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    const explanation = result.text;

                    if (explanation) {
                        // 3. Display result
                        resultText.textContent = explanation; // Display raw text
                        resultBox.classList.remove('hidden');
                    } else {
                        throw new Error("No explanation text received from server.");
                    }

                } catch (error) {
                    console.error("Error getting AI explanation:", error);
                    let displayError = error.message;
                     if (error.message.includes('Failed to fetch')) {
                        displayError = "Failed to connect to server. Is the Python server (app.py) running on port 5000?";
                    }
                    errorText.textContent = `Error: Could not get AI analysis. ${displayError}`;
                    errorBox.classList.remove('hidden');
                } finally {
                    // 4. Hide loading
                    loadingDiv.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>